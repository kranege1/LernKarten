<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LernKarten ‚Äì Admin</title>
  <link rel="stylesheet" href="styles.css">

  <!-- Firebase SDKs (matching index.html usage) -->
  <!-- Firebase compat builds (namespace style) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

  <script>
    // Firebase Configuration - bitte aus den Projekteinstellungen √ºbernehmen (wie in index.html)
    const firebaseConfig = {
      apiKey: "AIzaSyC84gMOM2_zLz3jiSeuQjbfDnPirPNz-6Y",
      authDomain: "lernkarten-fdadf.firebaseapp.com",
      projectId: "lernkarten-fdadf",
      storageBucket: "lernkarten-fdadf.firebasestorage.app",
      messagingSenderId: "768419395772",
      appId: "1:768419395772:web:d537f302bcde4c4fd1b8b9",
      measurementId: "G-KX3QBNTGGK",
    };

    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const fns = app.functions("europe-west1");
  </script>

  <style>
    .admin-container { max-width: 1000px; margin: 24px auto; padding: 0 16px; }
    .admin-header { display: flex; align-items: center; gap: 12px; }
    .admin-header h1 { margin: 0; }
    .badge { display: inline-block; padding: 2px 8px; font-size: 12px; border-radius: 999px; background: rgba(59,130,246,.15); color: #60a5fa; }
    .card-list { margin-top: 16px; }
    .table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .table th, .table td { padding: 10px 8px; border-bottom: 1px solid rgba(255,255,255,0.08); vertical-align: top; }
    .table th { text-align: left; color: var(--muted); font-weight: 600; }
    .actions { display: flex; gap: 8px; }
    .muted { color: var(--muted); }
    .small { font-size: 12px; }
  </style>
</head>
<body>
  <div class="admin-container">
    <div class="admin-header">
      <h1>Admin ‚Äì Community Einreichungen</h1>
      <span class="badge">Beta</span>
      <div style="margin-left:auto; display:flex; align-items:center; gap:8px;">
        <span id="admin-user" class="muted small" style="display:none;"></span>
        <button id="login" class="ghost">üîê Login</button>
        <button id="logout" class="ghost" style="display:none;">Logout</button>
      </div>
    </div>

    <div id="notice" class="muted small" style="margin-top:8px;">
      Hinweis: Nur die in Functions als <strong>ADMIN_EMAIL</strong> konfigurierte Adresse darf genehmigen. Andernfalls schl√§gt die Genehmigung fehl.
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="header-row" style="align-items:center;">
        <h2 style="margin:0;">Wartende Einreichungen</h2>
        <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
          <button id="refresh" class="ghost">üîÑ Aktualisieren</button>
        </div>
      </div>
      <div id="status" class="muted small" style="display:none; margin-top:8px;"></div>
      <div class="card-list" style="overflow:auto;">
        <table class="table" id="submissions-table">
          <thead>
            <tr>
              <th>Titel</th>
              <th>Benutzer</th>
              <th>Details</th>
              <th>Eingereicht</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody id="submissions-body">
            <tr><td colspan="5" class="muted">Lade‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <div class="header-row" style="align-items:center;">
      <h2 style="margin:0;">Ver√∂ffentlichte Decks</h2>
      <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <button id="refresh-published" class="ghost">üîÑ Aktualisieren</button>
      </div>
    </div>
    <div id="status-published" class="muted small" style="display:none; margin-top:8px;"></div>
    <div class="card-list" style="overflow:auto;">
      <table class="table" id="published-table">
        <thead>
          <tr>
            <th>Titel</th>
            <th>Kategorie</th>
            <th>Karten</th>
            <th>Erstellt</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody id="published-body">
          <tr><td colspan="5" class="muted">Lade‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const statusPubEl = document.getElementById('status-published');
    const adminUserEl = document.getElementById('admin-user');
    const loginBtn = document.getElementById('login');
    const logoutBtn = document.getElementById('logout');
    const refreshBtn = document.getElementById('refresh');
    const refreshPubBtn = document.getElementById('refresh-published');
    const tbody = document.getElementById('submissions-body');
    const pubBody = document.getElementById('published-body');

    function setStatus(msg, kind = 'info') {
      if (!msg) { statusEl.style.display = 'none'; statusEl.textContent = ''; return; }
      statusEl.style.display = 'block';
      statusEl.textContent = msg;
      statusEl.style.color = kind === 'error' ? '#ef4444' : '#9ca3af';
    }

    function setStatusPublished(msg, kind = 'info') {
      if (!msg) { statusPubEl.style.display = 'none'; statusPubEl.textContent = ''; return; }
      statusPubEl.style.display = 'block';
      statusPubEl.textContent = msg;
      statusPubEl.style.color = kind === 'error' ? '#ef4444' : '#9ca3af';
    }

    async function fetchPending() {
      setStatus('Lade wartende Einreichungen‚Ä¶');
      tbody.innerHTML = '<tr><td colspan="5" class="muted">Lade‚Ä¶</td></tr>';
      try {
        const snap = await db.collection('submissions').where('status','==','pending').get();
        if (snap.empty) {
          tbody.innerHTML = '<tr><td colspan="5" class="muted">Keine pending Einreichungen</td></tr>';
          setStatus(null);
          return;
        }
        const rows = [];
        snap.forEach(doc => {
          const d = doc.data();
          const submittedAt = d.submittedAt && d.submittedAt.toDate ? d.submittedAt.toDate() : null;
          const submittedStr = submittedAt ? submittedAt.toLocaleString() : '‚Äî';
          const tags = Array.isArray(d.tags) ? d.tags.join(', ') : '';
          const cardCount = Array.isArray(d.cards) ? d.cards.length : (d.cardCount || '‚Äî');
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><strong>${escapeHtml(d.title || '')}</strong><div class="small muted">${escapeHtml(d.category || '')} ¬∑ ${escapeHtml(d.difficulty || '')}</div></td>
            <td>${escapeHtml(d.userEmail || '')}<div class="small muted">UID: ${escapeHtml(d.userId || '')}</div></td>
            <td>${cardCount} Karten<div class="small muted">Tags: ${escapeHtml(tags)}</div></td>
            <td>${submittedStr}</td>
            <td class="actions">
              <button class="primary" data-approve="${doc.id}">‚úÖ Freigeben</button>
              <button class="ghost" data-delete="${doc.id}" style="color:#ef4444;">üóëÔ∏è L√∂schen</button>
            </td>
          `;
          rows.push(tr);
        });
        tbody.innerHTML = '';
        rows.forEach(r => tbody.appendChild(r));
      } catch (e) {
        console.error(e);
        setStatus('Fehler beim Laden: ' + (e && e.message ? e.message : e), 'error');
        tbody.innerHTML = '<tr><td colspan="5" class="muted">Fehler beim Laden</td></tr>';
      }
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    async function fetchPublished(){
      setStatusPublished('Lade ver√∂ffentlichte Decks‚Ä¶');
      pubBody.innerHTML = '<tr><td colspan="5" class="muted">Lade‚Ä¶</td></tr>';
      try{
        const url = `https://kranege1.github.io/LernKarten/shared-decks/catalog.json?cb=${Date.now()}`;
        const res = await fetch(url, { cache: 'no-cache' });
        if(!res.ok){ throw new Error('Katalog konnte nicht geladen werden'); }
        const catalog = await res.json();
        const rows = [];
        for(const deck of (catalog.decks || [])){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><strong>${escapeHtml(deck.title||'')}</strong></td>
            <td>${escapeHtml(deck.category||'')}</td>
            <td>${escapeHtml(String(deck.cardCount||''))}</td>
            <td>${escapeHtml(deck.created||'')}</td>
            <td class="actions">
              <a href="${escapeHtml(deck.downloadUrl||'#')}" target="_blank" class="ghost">üì• √ñffnen</a>
              <button class="ghost" data-delete-published="${escapeHtml(deck.fileName)}" style="color:#ef4444;">üóëÔ∏è L√∂schen</button>
            </td>
          `;
          rows.push(tr);
        }
        pubBody.innerHTML = '';
        if(rows.length===0){ pubBody.innerHTML = '<tr><td colspan="5" class="muted">Keine ver√∂ffentlichten Decks</td></tr>'; }
        rows.forEach(r=>pubBody.appendChild(r));
        setStatusPublished(null);
      } catch(e){
        console.error(e);
        setStatusPublished('Fehler beim Laden: ' + (e && e.message ? e.message : e), 'error');
        pubBody.innerHTML = '<tr><td colspan="5" class="muted">Fehler beim Laden</td></tr>';
      }
    }

    tbody.addEventListener('click', async (e) => {
      // Handle Approve button
      const approveBtn = e.target.closest('button[data-approve]');
      if (approveBtn) {
        const id = approveBtn.getAttribute('data-approve');
        approveBtn.disabled = true; approveBtn.textContent = '‚è≥ Freigabe‚Ä¶';
        setStatus('Genehmige Einreichung ' + id + ' ‚Ä¶');
        try {
          const approveDeck = fns.httpsCallable('approveDeck');
          const res = await approveDeck({ submissionId: id });
          setStatus(res?.data?.message || 'Erfolg: Freigegeben');
          setTimeout(fetchPending, 1200);
        } catch (err) {
          console.error('approve error', err);
          const msg = (err && (err.message || err.toString())) || 'Fehler';
          setStatus('Fehler bei Freigabe: ' + msg, 'error');
          approveBtn.disabled = false; approveBtn.textContent = '‚úÖ Freigeben';
        }
        return;
      }

      // Handle Delete button
      const deleteBtn = e.target.closest('button[data-delete]');
      if (deleteBtn) {
        const id = deleteBtn.getAttribute('data-delete');
        if (!confirm('Einreichung wirklich l√∂schen?')) return;
        deleteBtn.disabled = true; deleteBtn.textContent = '‚è≥ L√∂sche‚Ä¶';
        setStatus('L√∂sche Einreichung ' + id + ' ‚Ä¶');
        try {
          await db.collection('submissions').doc(id).delete();
          setStatus('Einreichung gel√∂scht');
          setTimeout(fetchPending, 500);
        } catch (err) {
          console.error('delete error', err);
          const msg = (err && (err.message || err.toString())) || 'Fehler';
          setStatus('Fehler beim L√∂schen: ' + msg, 'error');
          deleteBtn.disabled = false; deleteBtn.textContent = 'üóëÔ∏è L√∂schen';
        }
      }
    });

    pubBody.addEventListener('click', async (e) => {
      const delBtn = e.target.closest('button[data-delete-published]');
      if(!delBtn) return;
      const fileName = delBtn.getAttribute('data-delete-published');
      if(!confirm(`Ver√∂ffentlichtes Deck l√∂schen?\n${fileName}`)) return;
      delBtn.disabled = true; delBtn.textContent = '‚è≥ L√∂sche‚Ä¶';
      setStatusPublished('L√∂sche Deck ' + fileName + ' ‚Ä¶');
      try{
        const fn = fns.httpsCallable('deleteDeck');
        await fn({ fileName });
        setStatusPublished('Deck gel√∂scht');
        setTimeout(fetchPublished, 800);
      } catch(err){
        console.error('delete published error', err);
        const msg = (err && (err.message || err.toString())) || 'Fehler';
        setStatusPublished('Fehler beim L√∂schen: ' + msg, 'error');
        delBtn.disabled = false; delBtn.textContent = 'üóëÔ∏è L√∂schen';
      }
    });

    loginBtn.addEventListener('click', async () => {
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
      } catch (e) {
        console.error('login error', e);
        setStatus('Login fehlgeschlagen: ' + (e && e.message ? e.message : e), 'error');
      }
    });

    logoutBtn.addEventListener('click', async () => {
      try { await auth.signOut(); } catch (e) { console.error('logout error', e); }
    });

    refreshBtn.addEventListener('click', fetchPending);
    refreshPubBtn.addEventListener('click', fetchPublished);

    auth.onAuthStateChanged((user) => {
      if (user) {
        adminUserEl.style.display = 'inline';
        adminUserEl.textContent = user.displayName || user.email || '(ohne Name)';
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        fetchPending();
        fetchPublished();
      } else {
        adminUserEl.style.display = 'none';
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        tbody.innerHTML = '<tr><td colspan="5" class="muted">Bitte zuerst einloggen</td></tr>';
        pubBody.innerHTML = '<tr><td colspan="5" class="muted">Bitte zuerst einloggen</td></tr>';
      }
    });
  </script>
</body>
</html>
